import pandas
import os
import glob
import chardet


def clean_db(pathh):
    db = []
    try:
        reader = pandas.read_csv(pathh, encoding="latin1", header=None, sep=None, engine='python')
        result = reader[~reader[1].str.contains(r"RESERVED|REJECT", na=False)]
        result.fillna("None", inplace=True)
        return result
    except pandas.errors.ParserError as e:
        print("Malformed csv detected. Recommended action to load and re-save file.")
        return False
    except FileNotFoundError as e:
        print("File not found...")
        return False


path = "databases"
print("Note: Database MUST be of file type csv and have the following format\n"
      "ID | DESCRIPTION | EXTRA(OPTIONAL)\n")
if not os.path.isdir(path):
    print("Database directory not found... Creating directory.")
    os.mkdir("databases")
    print("Database directory created.")
databases = glob.glob1(path, "*.csv")
# Filter for specific data type here
r = len(databases)
if r == 0:
    print("No databases found")
else:

    opt = "0: Return\n"
    for x in range(r):
        # add option to return
        opt = opt + str(x + 1) + ": " + databases[x] + "\n"
    print("Databases available to clean:\n" + opt)
    while True:
        res = input("Select the database to clean (Remove entries that are reserved or rejected. "
                    "Remove excess columns past 3): ")
        if not res.isdigit():
            print("Improper Input")
        elif int(res) in range(1, r + 1):
            path = path + "/" + databases[int(res) - 1]
            cleaned = clean_db(path)
            if ~ cleaned:
                print("Cleaning failed. Exiting...")
                exit(1)
            split = path.split(".csv")
            cleaned.to_csv(split[0] + "_cleaned.csv", header=False, index=False)
            exit(0)
        elif res == "0":
            exit(0)
        else:
            print("Improper Input")
