import logging

import ipcalc

from core import driver
import socket
import signal
import sys
import netifaces


def signal_handler(sig, frame):
    print('\n\033[1;31mExiting...')
    sys.exit(0)


def get_subnets():
    nets = []
    inter = netifaces.interfaces()
    for i in inter:
        address = netifaces.ifaddresses(i)
        if netifaces.AF_INET in address:
            af_inet = address[netifaces.AF_INET]
            for afs in af_inet:
                if 'broadcast' in afs:
                    s = ipcalc.Network(afs["addr"], afs["netmask"])
                    nets.append(s)
                    print("Subnet of " + str(s) + " found")
    return nets


def in_subnet(subnets, ip):
    for sub in subnets:
        if ip in sub:
            return sub
    return False


if __name__ == "__main__":
    signal.signal(signal.SIGINT, signal_handler)
    while True:
        hostname = socket.gethostname()
        local_ip = socket.gethostbyname(hostname)
        interfaces = get_subnets()
        default = in_subnet(interfaces, local_ip)
        subnet = str(default)
        print("\033[1;31mDefault Host Address: " + local_ip)
        print(subnet + " subnet set as default for network discover")
        # print("\n\033[1;32mChoose Starting Mode:\n\033[1;37m1: Direct\n2: Remote\n")
        # mode = input()
        code = driver.start("1", subnet)
        if code == 1:
            exit(0)
        else:
            logging.error(code)
            exit(-1)
